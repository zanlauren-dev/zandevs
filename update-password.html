<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Update Password | Secure Terminal</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; }
        
        .glass-box {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 2.5rem;
        }

        .strength-bar {
            height: 4px;
            border-radius: 2px;
            transition: all 0.4s ease;
            width: 0%;
        }

        .animate-up { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <div id="loading-screen" class="fixed inset-0 bg-[#020617] z-50 flex items-center justify-center">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin"></div>
            <p class="text-slate-500 text-[10px] font-black uppercase tracking-[0.3em]">Validating Session...</p>
        </div>
    </div>

    <div class="glass-box w-full max-w-md p-10 shadow-2xl animate-up hidden" id="main-content">
        <div class="flex flex-col items-center mb-8">
            <div class="w-20 h-20 bg-indigo-600/10 rounded-3xl flex items-center justify-center border border-indigo-500/20 mb-6 shadow-inner">
                <i class="fas fa-fingerprint text-indigo-400 text-3xl"></i>
            </div>
            <h2 class="text-2xl font-black text-white uppercase tracking-tighter italic">Confirm <span class="text-indigo-500">Recovery</span></h2>
            <p class="text-slate-500 text-[10px] font-bold uppercase tracking-[0.2em] mt-2 text-center">Set your new terminal access credentials</p>
        </div>

        <form id="updatePassForm" class="space-y-6">
            <div class="space-y-4">
                <div class="relative">
                    <i class="fas fa-vault absolute left-5 top-1/2 -translate-y-1/2 text-slate-600"></i>
                    <input type="password" id="newPass" placeholder="New Password" 
                           oninput="evaluateStrength(this.value)"
                           class="w-full bg-black/20 border border-white/5 p-5 pl-14 pr-14 rounded-2xl text-white outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-bold tracking-widest" required>
                    
                    <button type="button" onclick="togglePass('newPass', 'eyeIcon')" class="absolute right-5 top-1/2 -translate-y-1/2 text-slate-600 hover:text-indigo-400">
                        <i id="eyeIcon" class="fas fa-eye"></i>
                    </button>
                </div>

                <div class="relative">
                    <i class="fas fa-check-double absolute left-5 top-1/2 -translate-y-1/2 text-slate-600"></i>
                    <input type="password" id="confirmPass" placeholder="Confirm Password" 
                           class="w-full bg-black/20 border border-white/5 p-5 pl-14 pr-14 rounded-2xl text-white outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-bold tracking-widest" required>
                    
                    <button type="button" onclick="togglePass('confirmPass', 'eyeIcon2')" class="absolute right-5 top-1/2 -translate-y-1/2 text-slate-600 hover:text-indigo-400">
                        <i id="eyeIcon2" class="fas fa-eye"></i>
                    </button>
                </div>

                <div class="px-2">
                    <div class="flex justify-between items-center mb-2">
                        <span id="strength-label" class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Strength: None</span>
                        <span id="strength-percent" class="text-[9px] font-black text-slate-600">0%</span>
                    </div>
                    <div class="w-full bg-white/5 rounded-full overflow-hidden">
                        <div id="strength-meter" class="strength-bar bg-slate-700"></div>
                    </div>
                </div>
            </div>

            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-5 rounded-2xl shadow-xl shadow-indigo-600/20 transition-all active:scale-95 flex items-center justify-center gap-3">
                <i class="fas fa-shield-check"></i>
                UPDATE & LOGIN
            </button>
        </form>

        <div class="mt-10 pt-6 border-t border-white/5 text-center">
            <a href="index.html" class="text-[9px] font-black uppercase tracking-[0.3em] text-slate-600 hover:text-indigo-400 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i> Cancel Recovery
            </a>
        </div>
    </div>

    <script>
        const SB_URL = 'https://cwxpffwqpbedjffvpsbj.supabase.co'; 
        const SB_KEY = 'sb_publishable_s2yXIg3L24wd0XYbrtnmPQ_HH_IN_e7';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        window.onload = async () => {
            const loader = document.getElementById('loading-screen');
            const content = document.getElementById('main-content');

            // Timeout para bigyan ng oras ang Supabase na i-process ang hash link
            setTimeout(async () => {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (session) {
                    loader.classList.add('hidden');
                    content.classList.remove('hidden');
                } else {
                    // Check kung galing sa recovery flow ang URL
                    const isRecovery = window.location.hash.includes('access_token') || window.location.href.includes('type=recovery');
                    
                    if (isRecovery) {
                        loader.classList.add('hidden');
                        content.classList.remove('hidden');
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Access Denied',
                            text: 'Invalid or expired recovery link. Please request a new one.',
                            background: '#0b1120', color: '#fff'
                        }).then(() => { window.location.href = 'index.html'; });
                    }
                }
            }, 600);
        };

        function evaluateStrength(password) {
            const meter = document.getElementById('strength-meter');
            const label = document.getElementById('strength-label');
            const percent = document.getElementById('strength-percent');
            let score = 0;

            if (password.length > 0) {
                if (password.length >= 6) score += 25;
                if (/[A-Z]/.test(password)) score += 25;
                if (/[0-9]/.test(password)) score += 25;
                if (/[^A-Za-z0-9]/.test(password)) score += 25;
            }

            meter.style.width = score + "%";
            percent.innerText = score + "%";

            if (score <= 25) {
                meter.className = "strength-bar bg-red-500";
                label.innerText = "Strength: Weak";
                label.className = "text-[9px] font-black text-red-500 uppercase tracking-widest";
            } else if (score <= 50) {
                meter.className = "strength-bar bg-orange-500";
                label.innerText = "Strength: Fair";
                label.className = "text-[9px] font-black text-orange-500 uppercase tracking-widest";
            } else if (score <= 75) {
                meter.className = "strength-bar bg-yellow-500";
                label.innerText = "Strength: Good";
                label.className = "text-[9px] font-black text-yellow-500 uppercase tracking-widest";
            } else {
                meter.className = "strength-bar bg-emerald-500";
                label.innerText = "Strength: Excellent";
                label.className = "text-[9px] font-black text-emerald-500 uppercase tracking-widest";
            }
        }

        function togglePass(id, iconId) {
            const input = document.getElementById(id);
            const icon = document.getElementById(iconId);
            input.type = input.type === 'password' ? 'text' : 'password';
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }

        document.getElementById('updatePassForm').onsubmit = async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('newPass').value;
            const confirmPassword = document.getElementById('confirmPass').value;

            if (newPassword.length < 6) {
                return Swal.fire({ icon: 'warning', title: 'Security Alert', text: 'Password must be at least 6 characters.', background: '#0b1120', color: '#fff' });
            }

            if (newPassword !== confirmPassword) {
                return Swal.fire({ icon: 'error', title: 'Mismatch', text: 'Passwords do not match!', background: '#0b1120', color: '#fff' });
            }

            Swal.fire({ 
                title: 'Updating Security...', 
                text: 'Reconfiguring terminal access...',
                background: '#0b1120', color: '#fff',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading() 
            });

            const { error } = await supabaseClient.auth.updateUser({ password: newPassword });

            if (error) {
                Swal.fire({ icon: 'error', title: 'Update Failed', text: error.message, background: '#0b1120', color: '#fff' });
            } else {
                // Mahalaga: Sign out muna para ma-clear ang old session bago mag-login ulit
                await supabaseClient.auth.signOut();
                Swal.fire({
                    icon: 'success',
                    title: 'Access Restored',
                    text: 'Success! Use your new password to log in.',
                    background: '#0b1120', color: '#fff'
                }).then(() => { window.location.href = 'index.html'; });
            }
        };
    </script>
</body>
</html>
