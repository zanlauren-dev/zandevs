<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Master Terminal | Admin Command</title>
<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet"/>
<style>
  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    min-height: 100vh;
    color: #cbd5e1;
  }
  /* Glassmorphism effect for cards and sections */
  .glass {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
  }
  .glass:hover {
    border-color: rgba(255, 255, 255, 0.4);
  }
  /* Animated border for header or sections */
  @keyframes gradientBorder {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .animated-border {
    background: linear-gradient(270deg, #4f46e5, #7c3aed, #ef4444, #f59e0b, #10b981, #4f46e5);
    background-size: 600% 600%;
    animation: gradientBorder 15s linear infinite;
  }
</style>
</head>
<body class="p-4 md:p-8">

<div class="container mx-auto max-w-7xl space-y-8">

  <!-- Header with animated gradient border -->
  <div class="border-4 rounded-3xl p-2 animated-border">
    <div class="glass p-6 flex flex-col lg:flex-row justify-between items-center space-y-4 lg:space-y-0">
      <h1 class="text-3xl font-extrabold uppercase tracking-widest text-white">Master Terminal</h1>
      <div class="flex items-center space-x-4">
        <button id="refreshBtn" class="bg-purple-600 px-4 py-2 rounded-lg hover:bg-purple-700 transition">Refresh</button>
        <button id="broadcastBtn" class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700 transition">New Broadcast</button>
        <button id="settingsBtn" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 transition">Settings</button>
      </div>
    </div>
  </div>

  <!-- Stats and Operational Table -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Stats Card -->
    <div class="glass p-4 shadow-xl hover:scale-105 transition-transform duration-300">
      <h2 class="text-sm uppercase font-bold mb-2">Total Submissions</h2>
      <p id="totalSubmissions" class="text-3xl font-extrabold">0</p>
    </div>
    <!-- Pending -->
    <div class="glass p-4 shadow-xl hover:scale-105 transition-transform duration-300">
      <h2 class="text-sm uppercase font-bold mb-2">Pending</h2>
      <p id="pendingCount" class="text-3xl font-extrabold">0</p>
    </div>
    <!-- Completed -->
    <div class="glass p-4 shadow-xl hover:scale-105 transition-transform duration-300">
      <h2 class="text-sm uppercase font-bold mb-2">Completed</h2>
      <p id="completedCount" class="text-3xl font-extrabold">0</p>
    </div>
  </div>

  <!-- Operational Table -->
  <div class="glass p-4 rounded-xl overflow-x-auto shadow-xl">
    <h3 class="text-lg uppercase font-bold mb-4 text-white">Submissions</h3>
    <table class="w-full text-left text-sm font-semibold uppercase text-slate-300 border-collapse border-spacing-y-2">
      <thead>
        <tr>
          <th class="px-4 py-2 border-b border-white/20">Name</th>
          <th class="px-4 py-2 border-b border-white/20">Email</th>
          <th class="px-4 py-2 border-b border-white/20">Method</th>
          <th class="px-4 py-2 border-b border-white/20">Status</th>
          <th class="px-4 py-2 border-b border-white/20">Actions</th>
        </tr>
      </thead>
      <tbody id="submissionsTableBody" class="divide-y divide-white/10"></tbody>
    </table>
  </div>

  <!-- New Section: Student Accounts with glassmorphism and animation -->
  <div class="mt-8 space-y-4">
    <h2 class="text-[10px] font-black uppercase tracking-widest italic text-white">Student Accounts</h2>
    <div class="overflow-x-auto rounded-xl border border-white/20 bg-[#0b1120]/80 p-4 shadow-xl hover:scale-105 transition-transform duration-300">
      <table class="w-full text-left text-[9px] font-black uppercase text-slate-500 tracking-widest border-collapse border-spacing-y-2">
        <thead class="border-b border-white/10">
          <tr>
            <th class="px-4 py-2">Name</th>
            <th class="px-4 py-2">Email</th>
            <th class="px-4 py-2">Method</th>
          </tr>
        </thead>
        <tbody id="usersTableBody" class="divide-y divide-white/10"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- SweetAlert2 modal scripts and other scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const SB_URL = 'https://cwxpffwqpbedjffvpsbj.supabase.co'; 
  const SB_KEY = 'sb_publishable_s2yXIg3L24wd0XYbrtnmPQ_HH_IN_e7';
  const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
  let submissions = [];

  // Fetch submissions
  async function fetchData() {
    const { data, error } = await supabaseClient.from('submissions').select('*').order('created_at', { ascending: false });
    if (error) { console.error("Sync Error:", error); return; }
    submissions = data || [];
    updateStats();
    renderTable();
  }

  function updateStats() {
    document.getElementById('totalSubmissions').innerText = submissions.length;
    const pending = submissions.filter(s => s.status === 'Pending').length;
    const completed = submissions.filter(s => s.status === 'Completed').length;
    document.getElementById('pendingCount').innerText = pending;
    document.getElementById('completedCount').innerText = completed;
  }

  function renderTable() {
    const tbody = document.getElementById('submissionsTableBody');
    tbody.innerHTML = '';
    if (submissions.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-4 text-center italic">No Submissions Found</td></tr>`;
      return;
    }
    submissions.forEach(sub => {
      tbody.innerHTML += `
        <tr class="hover:bg-white/10 transition-all rounded-lg">
          <td class="px-4 py-2">${sub.name}</td>
          <td class="px-4 py-2">${sub.email}</td>
          <td class="px-4 py-2">${sub.method}</td>
          <td class="px-4 py-2">${sub.status}</td>
          <td class="px-4 py-2 space-x-2">
            <button class="bg-green-600 px-2 py-1 rounded hover:bg-green-700 text-xs" onclick="approveSubmission('${sub.id}')">Approve</button>
            <button class="bg-red-600 px-2 py-1 rounded hover:bg-red-700 text-xs" onclick="rejectSubmission('${sub.id}')">Reject</button>
            <button class="bg-gray-600 px-2 py-1 rounded hover:bg-gray-700 text-xs" onclick="deleteSubmission('${sub.id}')">Delete</button>
          </td>
        </tr>`;
    });
  }

  // Placeholder functions for approve, reject, delete
  async function approveSubmission(id) { 
    await supabaseClient.from('submissions').update({status: 'Completed'}).eq('id', id);
    fetchData();
  }
  async function rejectSubmission(id) { 
    await supabaseClient.from('submissions').update({status: 'Rejected'}).eq('id', id);
    fetchData();
  }
  async function deleteSubmission(id) { 
    await supabaseClient.from('submissions').delete().eq('id', id);
    fetchData();
  }

  // Fetch user accounts
  async function fetchUserAccounts() {
    const { data, error } = await supabaseClient.from('users').select('*');
    if (error) { console.error('Error fetching users:', error); return; }
    renderUserAccounts(data || []);
  }

  function renderUserAccounts(users) {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';
    if (users.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-4 text-center italic">No User Accounts Found</td></tr>`;
      return;
    }
    users.forEach(user => {
      tbody.innerHTML += `
        <tr class="hover:bg-white/10 transition-all rounded-lg">
          <td class="px-4 py-2">${user.name}</td>
          <td class="px-4 py-2">${user.email}</td>
          <td class="px-4 py-2">${user.method}</td>
        </tr>`;
    });
  }

  // Button Event Listeners
  document.getElementById('refreshBtn').addEventListener('click', () => {
    fetchData();
  });

  document.getElementById('broadcastBtn').addEventListener('click', () => {
    // Show file upload dialog
    Swal.fire({
      title: 'Upload Files for Broadcast',
      html: `
        <input type="file" id="fileUpload" multiple class="w-full text-white" />
        <p class="text-sm mt-2">Allowed types: ppt, pptx, docx, pdf, images, etc.</p>
      `,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: 'Upload',
      preConfirm: () => {
        const files = document.getElementById('fileUpload').files;
        if (!files || files.length === 0) {
          Swal.showValidationMessage('Please select files to upload');
        }
        return files;
      }
    }).then(async (result) => {
      if (result.isConfirmed) {
        const files = result.value;
        // Loop through files and upload to database or storage
        for (let file of files) {
          // Example: upload to Supabase Storage
          const { data, error } = await supabase.storage
            .from('broadcasts')
            .upload(`broadcasts/${file.name}`, file);
          if (error) {
            Swal.fire('Error', `Failed to upload ${file.name}`, 'error');
            continue;
          }
        }
        Swal.fire('Success', 'Files uploaded and broadcast scheduled!', 'success');
      }
    });
  });

  document.getElementById('settingsBtn').addEventListener('click', () => {
    Swal.fire({
      title: 'Settings',
      html: `
        <div class="flex flex-col space-y-2 text-white">
          <label class="font-semibold">Notification Mode:</label>
          <select class="bg-gray-800 p-2 rounded" id="notificationMode">
            <option value="all">All Users</option>
            <option value="students">Students Only</option>
            <option value="admins">Admins Only</option>
          </select>
          <label class="font-semibold mt-2">Broadcast Interval (mins):</label>
          <input type="number" min="1" max="60" id="broadcastInterval" class="bg-gray-800 p-2 rounded" value="10" />
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Save',
      preConfirm: () => {
        const mode = document.getElementById('notificationMode').value;
        const interval = document.getElementById('broadcastInterval').value;
        // Save settings to localStorage or backend
        localStorage.setItem('notificationMode', mode);
        localStorage.setItem('broadcastInterval', interval);
        Swal.fire('Saved!', 'Your settings have been updated.', 'success');
      }
    });
  });

  // Initial fetch
  fetchData();
  fetchUserAccounts();

  // Refresh user accounts every minute
  setInterval(fetchUserAccounts, 60000);

</script>
</body>
</html>
